<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<title>时间的朋友|数独</title>
	<link href="images/favicon_books.ico" rel="shortcut icon">
	<link href="css/default.css" type="text/css" rel="stylesheet">
	<link href="css/foot.css" type="text/css" rel="stylesheet">
	<link href="css/font-awesome.min.css" rel="stylesheet">

	<script src="js/solver.js"></script>
</head>

<body>
	<div id='sudoku'>
		<div id='banner'>
			<span id='big'>——数独在线求解器——</span>
			<span id='small'>提供可选提示。</span>
		</div>

		<div id='main'>
			<table>
				<tr>
					<td>
						<canvas id='canvas2' width='541' height='55' title="Click here to set the currently selected digit">Canvas is not supported by this browser.</canvas>
						<canvas id='canvas1' width='541' height='541'>Canvas is not supported by this browser.</canvas>
						<input id='tbSerial' style='width: 538px; background-color: #faf0e6; margin-top: 10px;' />
						<br/><br/>
						<span id="extraInfo" style='font-size:0.7em; color: #696969;'></span><br/>
					</td>
					<td style="width: 135px">
						<button onclick="clearGame()" title='Clears all cells including givens. Use this initially when entering a new problem.'>Clear</button><br/>
						<button onclick="loadText()" title='Loads the digits from the textbox below the board in order left to right, top to bottom. Click this after entering a problem to convert them to givens'>Load</button><br/>
						<button id="btnReset" onclick="reset()" title='Clears all user entered cells. The givens are NOT cleared.'>Reset</button><br/>
						<button id="btnAccept" onclick="acceptPossibles()" title='Makes all singles into values'>Accept</button><br/>
						<button id="btnHint" onclick="hint()" title='Enters the answer to the currently selected cell'>Hint</button><br/>
						<button id="btnUndo" onclick="undo()" title='Undoes the last user action except load, clear and reset'>Undo</button><br/>
						<button id="btnSolve" onclick="solve()" title='If possible, it will solve the problem. The amount of time taken to solve is displayed below.'>Solve</button><br/><br/> Show allowed: <input id='chbAllowed' type="checkbox" checked='yes' title='Untick this to hide allowed values'
						/><br/> Show singles: <input id='chbShowSingles' type="checkbox" checked='yes' title='Untick this to hide naked and hidden singles - these are shown in red' /><br/>
						<span id="message" style="width: 130; color: Red; "></span><br/>

					</td>
					<td class="help">
						<h2>Instructions</h2>
						<ul>
							<li>Hit the Clear button and enter the Sudoku 'givens' manually. You can do this by clicking on a cell, or use the keyboard arrow keys, then type the digit from '1' to '9'. The Delete key or the '0' key will clear a cell. You can also enter a digit
								or clear it by clicking in the row of digits above the board.</li>
							<li>When you are finished hit the Load button. The givens will now appear in blue.</li>
							<li>Hitting the Reset button will now undo all changes and take you back to the original givens.</li>
							<li>The allowed digits are shown as a small light gray digit in the background of each cell. You can turn this off by unticking the 'Show allowed' option.</li>
							<li>If an allowed digit is the only possible digit (these are called singles) then it is highlighted in red. You can turn this off by unticking the 'Show singles' option.</li>
							<li>Hitting the Accept button will convert singles to actual entered digits.</li>
							<li>The Hint button will fill in the current selected cell with the correct digit.</li>
							<li>Clicking in a cell with a digit entered will highlight the same digit anywhere alse in red.</li>
							<li>Solve of course will solve the entire puzzle.</li>
							<li>Undo will undo the last user action such as entering a digit or htting the Accept button.</li>
						</ul>
					</td>
				</tr>
			</table>

			<script type="text/javascript">
				var CellSize = 60;
				var SubCellSize = 18;

				var canvas1 = document.getElementById("canvas1");
				var canvas2 = document.getElementById("canvas2");
				var chbAllowed = document.getElementById("chbAllowed");
				var chbShowSingles = document.getElementById("chbShowSingles");
				var tbSerial = document.getElementById("tbSerial");
				var extraInfo = document.getElementById("extraInfo");

				var board1 = new Board();
				var selectRow = 0;
				var selectCol = 0;
				var showAllowed = true;
				var showSingles = true;
				var undoStack = Array();

				function undo() {
					var tos = undoStack.pop();
					if (tos) {
						board1 = tos;
						updateUI();
					}
				}

				function clearUndo() {
					undoStack = Array();
				}

				function pushBoard() {
					undoStack.push(board1.clone());
				}

				function checkStatus() {
					extraInfo.innerHTML = "";
					if (!board1._isValid)
						message.innerHTML = "*Invalid*";
					else if (board1._isSolved)
						message.innerHTML = "*Solved*";
					else
						message.innerHTML = "";
				}

				function drawGrid() {
					// Only ever called once!
					var context = canvas1.getContext('2d');
					context.strokeStyle = '#808080';
					for (var i = 0; i <= BoardSize; i++) {
						context.beginPath();
						var thick = i % 3 == 0;
						// Draw vertical lines
						context.lineWidth = thick ? 2 : 1;
						context.moveTo(i * CellSize + 0.5, 0.5);
						context.lineTo(i * CellSize + 0.5, BoardSize * CellSize + 0.5);

						// Draw horizontal lines
						context.moveTo(0.5, i * CellSize + 0.5);
						context.lineTo(BoardSize * CellSize + 0.5, i * CellSize + 0.5);
						context.stroke();
					}
				}

				function drawCells() {
					var context = canvas1.getContext('2d');

					context.font = "12pt Calibri"; // small text
					context.textAlign = "center";
					context.textBaseline = "middle";
					var normalColor = "#aaaaaa";
					var singleColor = "#ff143c";

					// Draw background for selected cell
					for (var row = 0; row < BoardSize; row++)
						for (var col = 0; col < BoardSize; col++) {

							// Draw background of selected cell
							if (row == selectRow && col == selectCol) {
								var margin = 2;
								context.beginPath();
								context.rect(col * CellSize + margin + 0.5, row * CellSize + margin + 0.5, CellSize - 2 * margin, CellSize - 2 * margin);
								context.fillStyle = "#ffe4e1";
								context.fill()
							}
						}
					context.fillStyle = "#999999"; // text color - light

					// Draw allowed values
					if (showAllowed)
						for (var row = 0; row < BoardSize; row++)
							for (var col = 0; col < BoardSize; col++) {
								var cell = board1.getCell(new Location(row, col));
								if (!cell.isAssigned()) {
									var allowedValues = cell._allowed.allowedValuesArray();
									for (var i = 0; i < allowedValues.length; i++) {
										var val = allowedValues[i];
										var x = (col + 0.5) * CellSize; // center of cell for textAlign center, textBaseline middle
										var y = (row + 0.5) * CellSize;
										var subRow = Math.floor((val - 1) / 3) - 1;
										var subCol = Math.floor((val - 1) % 3) - 1;
										x += subCol * SubCellSize;
										y += subRow * SubCellSize;
										var hiddenSingle = allowedValues.length != 1 && val == cell.getAnswer(); // naked single would have only one allowed value
										context.fillStyle = normalColor; // show hidden single in purple
										if (showSingles && val == cell.getAnswer())
											context.fillStyle = singleColor; // show hidden single in purple
										context.fillText(val, x, y);
									}
								}
							}

					// New if a digit is selected then make all cells with the same digit foreground red
					var selectCell = board1.getCell(new Location(selectRow, selectCol));
					var selectValue = selectCell.getValue();

					// Draw values last
					context.font = "32pt Calibri";
					context.textAlign = "center";
					context.textBaseline = "middle";
					var normalForeColor = "#191929";
					var sameDigitForeColor = "#F91919";
					context.fillStyle = normalForeColor; // text color - dark
					for (var row = 0; row < BoardSize; row++)
						for (var col = 0; col < BoardSize; col++) {
							var cell = board1.getCell(new Location(row, col));
							var x = (col + 0.5) * CellSize; // center of cell for textAlign center, textBaseline middle
							var y = (row + 0.5) * CellSize;
							var sameDigit = cell.getValue() == selectValue && selectValue != 0;
							// Draw value
							var value = cell.getValue();
							if (value != 0) {
								context.fillStyle = cell.isGiven() ? "#2200aa" : "#696969"; // show "givens" in a darker color
								if (sameDigit) // then override
									context.fillStyle = sameDigitForeColor; // text color - dark
								context.fillText(value, x, y);
							}
						}
				}

				function drawCanvas() {
					canvas1.width = canvas1.width;
					drawGrid();
					drawCells();
				}

				function updateUI() {
					drawCanvas();
					checkStatus();
					tbSerial.value = board1.toString();
				}

				function readOptions() {
					showAllowed = chbAllowed.checked;
					showSingles = chbShowSingles.checked;
					drawCanvas();
				}

				chbAllowed.onclick = readOptions;
				chbShowSingles.onclick = readOptions;

				function selectCell(row, col) {
					selectRow = row;
					selectCol = col;
					drawCanvas();
				}

				function moveSelection(row, col) {
					selectRow += row;
					selectCol += col;
					if (selectRow < 0)
						selectRow = 8;
					else if (selectRow > 8)
						selectRow = 0;
					if (selectCol < 0)
						selectCol = 8;
					else if (selectCol > 8)
						selectCol = 0;
					drawCanvas();
				}

				function setDigitInCell(digit) {
					var cell = board1.getCell(new Location(selectRow, selectCol));
					message.innerHTML = "";
					if (cell.isGiven())
						return;
					if (digit != 0 && !cell.isAllowed(digit)) {
						message.innerHTML = "Digit not allowed";
						return;
					}
					pushBoard();
					cell.setValue(digit);
					board1.updateAllowed();
					updateUI();
				}

				canvas1.onmousedown = function canvasMouseDown(ev) {
					var x = ev.pageX - this.offsetLeft;
					var y = ev.pageY - this.offsetTop;
					var coords = this.relMouseCoords(ev);
					selectCell(Math.floor(coords.y / CellSize), Math.floor(coords.x / CellSize));
				}

				document.onkeydown = function(ev) {
					switch (ev.keyCode) {
						case 37: // left arrow
							moveSelection(0, -1);
							break;
						case 38: // up arrow
							moveSelection(-1, 0);
							break;
						case 39: // right arrow
							moveSelection(0, 1);
							break;
						case 40: // down arrow
							moveSelection(1, 0);
							break;
						default:
							var key = Number(ev.keyCode);
							var digit = key >= 96 ? key - 96 : key - 48; // handle keypad digits as well
							if (digit >= 0 && digit <= 9)
								setDigitInCell(digit);
							break;
					}
				}

				function loadText() {
					var ret = board1.setString(tbSerial.value);
					updateUI();
					if (!ret)
						message.innerHTML = "String is not of length 81";
				}

				function clearGame() {
					clearUndo();
					board1.clear();
					updateUI();
				}

				function acceptPossibles() {
					pushBoard();
					board1.acceptPossibles();
					board1.updateAllowed();
					updateUI();
				}

				function hint() {
					// First check if we had calculated a solution, if not do so now
					solution = board1.clone();
					if (solution.trySolve(Location.empty, 0)) {
						// There is a solution to the board from its current state
						var cell = solution.getCell(new Location(selectRow, selectCol));
						if (!cell.isGiven())
							setDigitInCell(cell.getValue());
					}
				}

				function reset() {
					clearUndo();
					board1.reset();
					updateUI();
				}

				function solve() {
					pushBoard();
					var n = new Date(); // Grab new copy of date
					var s = n.getTime(); // Grab current millisecond #
					board1.trySolve(Location.empty, 0);
					var diff = new Date().getTime() - s;
					updateUI();
					extraInfo.innerHTML = "Solve took " + String(diff) + " milliseconds";
				}

				//http://magictour.free.fr/sudoku.htm for list of hard Sudoku puzzles
				// http://www.sudokuwiki.org/sudoku.htm good on-line solver accepting serial format
				//board1.setString("7.8...3.....2.1...5.........4.....263...8.......1...9..9.6....4....7.5..........."); //very hard
				board1.setString("7.8...3.....2.1...5..7..2...4.....263.948...7...1...9..9.6....4....7.5....5......"); // medium
				updateUI();
				var digCellSize = 54;

				// New stuff - draw a digit selector in canvas above board
				function initDigitSource() {
					// Only ever called once!
					var context = canvas2.getContext('2d');
					context.strokeStyle = '#808080';
					var SourceSize = BoardSize + 1;
					for (var i = 0; i <= SourceSize; i++) {
						context.beginPath();
						// Draw vertical lines
						context.lineWidth = 1;
						context.moveTo(i * digCellSize + 0.5, 0.5);
						context.lineTo(i * digCellSize + 0.5, digCellSize + 0.5);
						context.stroke();
					}
					for (var i = 0; i <= 1; i++) {
						context.beginPath();
						// Draw horizontal lines
						context.lineWidth = 1;
						context.moveTo(0.5, i * digCellSize + 0.5);
						context.lineTo(SourceSize * digCellSize + 0.5, i * digCellSize + 0.5);
						context.stroke();
					}
					context.font = "24pt Calibri";
					context.textAlign = "center";
					context.textBaseline = "middle";
					var normalForeColor = "#708090";
					context.fillStyle = normalForeColor; // text color - dark
					for (var col = 0; col < SourceSize; col++) {
						var x = (col + 0.5) * digCellSize; // center of cell for textAlign center, textBaseline middle
						var y = 0.5 * digCellSize;
						var value = col < 9 ? col + 1 : "Del";
						context.fillStyle = normalForeColor; // show "givens" in a darker color
						context.fillText(value, x, y);
					}

				}
				initDigitSource();

				canvas2.onmousedown = function canvasMouseDown(ev) {
					var x = ev.pageX - this.offsetLeft;
					var y = ev.pageY - this.offsetTop;
					var coords = this.relMouseCoords(ev);
					var dig = Math.floor(coords.x / digCellSize) + 1;
					if (dig == 10)
						dig = 0;
					setDigitInCell(dig);
				}
			</script>
		</div>

	</div>
	<!--页脚-->
	<div class="foot">
		<a href="https://github.com/taketimeasafriend" target="view_window"><i class="fa fa-github"></i>Github</a>
		 -
		<a href="http://weibo.com/miaoxiaogege" target="view_window"><i class="fa fa-weibo"></i>微博</a>
		 -
		<a href="http://ogudt6aal.bkt.clouddn.com/image/whynotwangwei.jpeg" target="view_window"><i class="fa fa-weixin"></i>微信</a>
		 -
		<a href="mailto:taketimeasafriend@gmail.com?subject=I%20want%20to%20say%20&body=Hello%20"><i class="fa fa-envelope"></i>邮箱</a>
	</div>
</body>

</html>
